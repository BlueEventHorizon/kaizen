---
name: fix-staged
user-invocable: false
description: |
  コード・文書の修正実行。AI専用Skill。
  レビュー指摘事項に基づいてコード・文書を修正する。
  /kaizen:present-staged からの対話的修正、/kaizen:review --auto-fix からの自動修正で使用。
argument-hint: "<修正モード> (--single | --batch)"
---

# /fix-staged Skill

レビュー指摘事項に基づいてコード・文書を修正する AI 専用 Skill。
参考文書を収集し（DocAdvisor Skill または `.doc_structure.yaml` パスで Glob）、general-purpose subagent に修正を委譲する。

## 設計原則

| 原則 | 説明 |
|------|------|
| 修正の実行は subagent | メインコンテキストの消費を抑え、修正のコード Read/Edit を subagent 側で完結させる |
| 参考文書取得（DocAdvisor Skill or .doc_structure.yaml） | 設計意図・ルールを踏まえた修正を保証する |
| 呼び出し元が入力に責任を持つ | 指摘事項・対象ファイル・種別を漏れなく渡す責務は呼び出し元にある |

## 入力・やりかた・Agent・出力

| 観点 | 内容 |
|------|------|
| **入力** | ① 修正対象の指摘事項（テキスト） ② 対象ファイルパス ③ レビュー種別 ④ 修正方針（任意） |
| **やりかた** | 参考文書取得（DocAdvisor Skill or `.doc_structure.yaml` パスで Glob）→ general-purpose subagent に修正を委譲 |
| **Agent** | DocAdvisor Skill 呼び出し: メインコンテキスト / 修正実行: general-purpose subagent |
| **出力** | 修正サマリー（修正ファイル・修正内容・影響範囲） |

---

## 入力仕様 [MANDATORY]

### 修正モード

| `$ARGUMENTS` | モード | 用途 |
|--------------|--------|------|
| `--single` | 1件修正 | /kaizen:present-staged の「段階的に解決」で 1 件ずつ修正 |
| `--batch` | 一括修正 | /kaizen:present-staged の「✅を一括修正」、/kaizen:review の「--auto-fix」 |

### 呼び出し元から受け取る情報 [MANDATORY]

呼び出し元（/kaizen:present-staged または /kaizen:review）は、以下を**漏れなく**提供する責務を持つ：

| 項目 | 必須 | 説明 |
|------|------|------|
| 指摘事項の詳細 | 必須 | 問題の説明・箇所（ファイル:行）・修正案を含むテキスト |
| 対象ファイルパス | 必須 | 修正対象のファイルパス一覧 |
| レビュー種別 | 必須 | `code` / `requirement` / `design` / `plan` / `generic` |
| ユーザーが選択した修正方針 | 任意 | AskUserQuestion の回答（A案/B案等）がある場合 |

---

## ワークフロー

> **前提条件**: `.doc_structure.yaml` がプロジェクトルートに存在すること。
> 呼び出し元（`/kaizen:review` または `/kaizen:present-staged`）が事前に存在確認している前提で動作する。

### Step 1: 入力の受け取り

呼び出し元から指摘事項・対象ファイル・レビュー種別・修正方針を受け取る。

入力が不足している場合は呼び出し元にエラーを返す（ユーザーに直接質問しない）。

### Step 2: 参考文書収集 [MANDATORY]

指摘事項の内容と対象ファイルに基づき、参考文書を収集する。

#### 2.0 generic 種別の場合

review Phase 2 と同様、`/query-rules` / `/query-specs` は**使用しない**。
参考文書は最小限:
- `{review_criteria_path}` の「5. 汎用文書レビュー観点」（存在すれば）

> `{review_criteria_path}` は `/kaizen:review` の「レビュー観点の探索」と同じフォールバックで決定する:
> 1. `/query-rules` Skill（利用不可ならスキップ）→ 2. `.claude/review-config.yaml` → 3. `${CLAUDE_PLUGIN_ROOT}/defaults/review_criteria.md`

generic 以外の種別 → 2.1 へ進む。

#### 2.1 DocAdvisor Skill を試行

`.claude/skills/query-rules/SKILL.md` が存在するか確認する。存在すれば DocAdvisor が利用可能と判断し、以下の Skill を呼び出す:

- `/query-rules` に「修正作業に必要なルール文書」を問い合わせ
  - 問い合わせ内容: 修正内容の要約、対象ファイル、レビュー種別
- `/query-specs` に「修正作業に必要な要件定義書・設計書」を問い合わせ
  - 問い合わせ内容: 修正内容の要約、対象ファイル

DocAdvisor が利用不可（`.claude/skills/query-rules/SKILL.md` が存在しない等）の場合、2.2 のフォールバックに移行する。

#### 2.2 DocAdvisor 利用不可時のフォールバック

`.doc_structure.yaml` のパス定義を使って参考文書を収集する:

1. `.doc_structure.yaml` の `rules` カテゴリの `paths` から rules 文書を Glob 探索
2. `.doc_structure.yaml` の `specs` カテゴリの `paths` から関連仕様書を Glob 探索
3. `{review_criteria_path}` を参照に含める
4. 見つからないファイルはスキップ（エラーにしない）
5. 参考文書なしでも修正は試みる（指摘事項の情報のみで実行）

### Step 3: subagent 起動 [MANDATORY]

Fixer プロンプトテンプレートに従い、general-purpose subagent を起動する。

```
subagent_type: general-purpose
prompt: |
  [Fixer プロンプトテンプレートに基づいて構成]
```

subagent が全参考文書を Read し、修正を実行し、サマリーを報告する。

### Step 4: 結果を呼び出し元に返す

subagent の修正サマリーを呼び出し元に返す。呼び出し元（/kaizen:present-staged または /kaizen:review）がユーザーへの報告を担当する。

---

## Fixer プロンプトテンプレート [MANDATORY]

### --single モード（1件修正）

```
以下の指摘事項に基づいて修正を実行してください。

## 修正対象の指摘事項
[指摘事項の詳細テキスト]

## ユーザーが選択した修正方針
[修正方針がある場合のみ記載。ない場合はこのセクションを省略]

## 対象ファイル（修正前に必ず Read すること）
[ファイルパスリスト]

## 参考文書（全て Read して理解すること）
### ルール文書
[収集したルール文書パスリスト]
### 要件定義書・設計書
[収集した仕様書パスリスト]

## 指示
- 指摘事項に記載された問題のみを修正する
- 指摘事項に関係のない変更は一切行わない
- ユーザーが修正方針を選択している場合、その方針に従う
- 参考文書のルール・設計意図に従って修正する
- 修正内容をサマリーで報告する

## 出力形式
### 修正サマリー
1. **[修正項目名]**
   - ファイル: [修正したファイルパス]
   - 内容: [何をどう変更したか 1-2行]
   - 影響: [他に確認が必要な箇所があれば記載、なければ「なし」]
```

> --batch では「修正方針」セクションを省略する。✅一括修正は修正が一意に決まる自明な項目のみ、--auto-fix はユーザー介入なしのため。

### --batch モード（一括修正）

```
以下の指摘事項に基づいて修正を実行してください。
複数の指摘事項があります。全て修正してください。

## 修正対象の指摘事項
[指摘事項1の詳細テキスト]

[指摘事項2の詳細テキスト]

...

## 対象ファイル
[全指摘事項に関連するファイルパスリスト]

## 参考文書（全て Read して理解すること）
### ルール文書
[収集したルール文書パスリスト]
### 要件定義書・設計書
[収集した仕様書パスリスト]

## 指示
- 指摘事項に記載された問題のみを修正する
- 指摘事項に関係のない変更は一切行わない
- 参考文書のルール・設計意図に従って修正する
- 各指摘事項ごとに修正内容をサマリーで報告する

## 出力形式
### 修正サマリー
1. **[修正項目名1]**
   - ファイル: [修正したファイルパス]
   - 内容: [何をどう変更したか 1-2行]
   - 影響: [他に確認が必要な箇所があれば記載、なければ「なし」]
2. **[修正項目名2]**
   - ファイル: ...
   ...
```

---

## エラーハンドリング

| エラー | 対応 |
|--------|------|
| 入力不足（指摘事項なし・対象ファイルなし） | 呼び出し元にエラーを返す。ユーザーに直接質問しない |
| DocAdvisor Skill 利用不可 | フォールバック手順に従う（Step 2.2 参照） |
| subagent 起動失敗 | エラー内容を呼び出し元に返す |
| subagent が修正失敗を報告 | エラー内容を呼び出し元に返す。呼び出し元がユーザーに報告 |
| subagent が指摘事項と無関係な変更を報告 | 呼び出し元がサマリーを確認し、ユーザーに報告して判断を仰ぐ |
